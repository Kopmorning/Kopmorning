name: Deploy to EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— push ë  ë•Œë§Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Deploy to EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
          # ì„œë²„ ì‘ì—… ì‹œì‘
          cd ~/app  # ğŸ‘‰ EC2ì— clone í•´ë†“ì€ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          git pull origin main  # ì½”ë“œ ìµœì‹ í™”
          
          # ë¹Œë“œ
          ./gradlew clean build -x test
          
          # ë„ì»¤ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          docker stop -app || true
          docker rm kopmorning-app || true
          
          # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t kopmorning-app .
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d -p 8080:8080 --name kopmorning-app kopmorning-app
        EOF
